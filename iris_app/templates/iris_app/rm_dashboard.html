{% extends 'iris_app/base.html' %}
{% load static %}

{% block title %}RM Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <h2 class="fw-bold section-title">RM Approval Dashboard</h2>
        <p class="text-muted">Review grassroot ideas from your team members</p>
    </div>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4 py-3">Ideator</th>
                            <th class="py-3">Idea Summary</th>
                            <th class="py-3">Category</th>
                            <th class="py-3">Date</th>
                            <th class="py-3 pe-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        {% for idea in ideas %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">{{ idea.ideator.full_name }}</div>
                                <div class="small text-muted">{{ idea.ideator.employee_id }}</div>
                            </td>
                            <td>
                                <div class="text-dark">{{ idea.proposed_idea|truncatewords:15 }}</div>
                            </td>
                            <td>
                                <span class="badge bg-info-subtle text-info rounded-pill px-3">
                                    {{ idea.improvement_category.name }}
                                </span>
                            </td>
                            <td class="text-muted">
                                {{ idea.created_at|date:"M d, Y" }}
                            </td>
                            <td class="pe-4 text-center">
                                <div class="btn-group btn-group-sm bg-white border rounded-pill p-1 shadow-sm">
                                    <button class="btn btn-outline-success border-0 rounded-pill px-3"
                                        onclick="openApproveModal('{{ idea.idea_id }}', '{{ idea.ideator.full_name }}')">
                                        Approve
                                    </button>
                                    <button class="btn btn-outline-warning border-0 rounded-pill px-3"
                                        onclick="openReworkModal('{{ idea.idea_id }}')">
                                        Rework
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <p class="text-muted mb-0">No pending ideas for approval.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header bg-success text-white rounded-top-4 py-3 px-4">
                <h5 class="modal-title fw-bold">Approve Grassroot Idea</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="approveForm" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">Evaluating idea for: <span id="approveIdeatorName"
                            class="fw-bold text-dark"></span></p>

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-uppercase text-muted">Business Value
                            Questions</label>
                        <div class="space-y-3">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded-3 mb-2">
                                <span class="small">Is the idea Desirable by the customer?</span>
                                <div>
                                    <input type="radio" class="btn-check" name="is_desirable" id="des_y" value="YES"
                                        required checked>
                                    <label class="btn btn-sm btn-outline-success rounded-pill px-3"
                                        for="des_y">Yes</label>
                                    <input type="radio" class="btn-check" name="is_desirable" id="des_n" value="NO">
                                    <label class="btn btn-sm btn-outline-danger rounded-pill px-3"
                                        for="des_n">No</label>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded-3 mb-2">
                                <span class="small">Is the idea Feasible with the tech stack?</span>
                                <div>
                                    <input type="radio" class="btn-check" name="is_feasible" id="fea_y" value="YES"
                                        required checked>
                                    <label class="btn btn-sm btn-outline-success rounded-pill px-3"
                                        for="fea_y">Yes</label>
                                    <input type="radio" class="btn-check" name="is_feasible" id="fea_n" value="NO">
                                    <label class="btn btn-sm btn-outline-danger rounded-pill px-3"
                                        for="fea_n">No</label>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded-3 mb-2">
                                <span class="small">Is the idea Viable in environment?</span>
                                <div>
                                    <input type="radio" class="btn-check" name="is_viable" id="via_y" value="YES"
                                        required checked>
                                    <label class="btn btn-sm btn-outline-success rounded-pill px-3"
                                        for="via_y">Yes</label>
                                    <input type="radio" class="btn-check" name="is_viable" id="via_n" value="NO">
                                    <label class="btn btn-sm btn-outline-danger rounded-pill px-3"
                                        for="via_n">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label fw-bold small text-uppercase text-muted">Remarks</label>
                        <textarea class="form-control bg-light" name="remarks" rows="3"
                            placeholder="Add your evaluation remarks..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="submit" class="btn btn-success w-100 rounded-pill py-2 fw-bold shadow-sm">Submit
                        Approval</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rework/Reject Modal -->
<div class="modal fade" id="reworkModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header bg-warning text-dark border-0 rounded-top-4 py-3 px-4">
                <h5 class="modal-title fw-bold">Decision</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reworkForm" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4 text-center">
                    <p class="mb-4">Do you want the user to rework on the idea?</p>
                    <div class="d-grid gap-2">
                        <button type="submit" name="rework_needed" value="YES"
                            class="btn btn-warning rounded-pill py-2 fw-bold">Yes, Rework</button>
                        <button type="submit" name="rework_needed" value="NO"
                            class="btn btn-danger rounded-pill py-2 fw-bold">No, Reject</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function openApproveModal(ideaId, ideatorName) {
        $('#approveIdeatorName').text(ideatorName);
        $('#approveForm').attr('action', '/evaluate-grassroot/' + ideaId + '/');
        new bootstrap.Modal('#approveModal').show();
    }

    function openReworkModal(ideaId) {
        $('#reworkForm').attr('action', '/rework-grassroot/' + ideaId + '/');
        new bootstrap.Modal('#reworkModal').show();
    }
</script>
{% endblock %}