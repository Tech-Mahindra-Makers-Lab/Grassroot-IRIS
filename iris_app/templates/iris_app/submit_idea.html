{% extends 'iris_app/base.html' %}
{% load static %}

{% block title %}Submit Idea{% endblock %}

{% block extra_css %}
<style>
    /* Reuse consistent styles */
    .form-header {
        background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
        url('{% static "iris_app/images/innovation_header.jpg" %}') center/cover;
        padding: 50px 0;
        color: white;
        margin-bottom: -80px;
        position: relative;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 40px;
    }

    .wizard-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .wizard-container::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 10%;
        right: 10%;
        height: 1px;
        background: #CBD5E1;
        z-index: 1;
    }

    .wizard-step {
        position: relative;
        z-index: 2;
        text-align: center;
        width: 25%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #475569;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }

    .wizard-step.active .step-number {
        background: #E31837;
        box-shadow: 0 0 0 5px rgba(227, 24, 55, 0.1);
    }

    .wizard-step.completed .step-number {
        background: #10B981;
    }

    .step-label {
        font-size: 13px;
        font-weight: 600;
        color: #64748B;
    }

    .wizard-step.active .step-label {
        color: #E31837;
    }

    .form-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 40px;
        margin-bottom: 30px;
        display: none;
        animation: fadeIn 0.4s ease;
    }

    .form-card.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card-title-custom {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #F1F5F9;
        padding-bottom: 10px;
    }

    .footer-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #E2E8F0;
    }

    .btn-next {
        background: #1E293B;
        color: white;
        padding: 10px 30px;
        border-radius: 50px;
        border: none;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-next:hover {
        background: #0F172A;
        transform: translateY(-1px);
    }

    .btn-prev {
        background: transparent;
        color: #64748B;
        border: 1px solid #CBD5E1;
        padding: 10px 30px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-prev:hover {
        background: #F8FAFC;
        color: #1E293B;
    }

    .summary-group {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    .summary-label {
        font-weight: 600;
        color: #64748B;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="post-challenge-page">
    <section class="form-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="fw-bold mb-1" style="font-size: 32px;">Submit Your Idea</h1>
                <p class="mb-0 opacity-90" style="font-size: 14px;">Challenge: {{ challenge.title }}</p>
            </div>
        </div>
    </section>

    <div class="container" style="position: relative; z-index: 10; margin-top: 30px;">
        <!-- Wizard Progress Bar -->
        <div class="wizard-container">
            <div class="wizard-step active" id="wizard-step-1">
                <div class="step-number">1</div>
                <div class="step-label">Your Details</div>
            </div>
            <div class="wizard-step" id="wizard-step-2">
                <div class="step-number">2</div>
                <div class="step-label">Idea Details</div>
            </div>
            <div class="wizard-step" id="wizard-step-3">
                <div class="step-number">3</div>
                <div class="step-label">Value Proposition</div>
            </div>
            <div class="wizard-step" id="wizard-step-4">
                <div class="step-number">4</div>
                <div class="step-label">Review & Submit</div>
            </div>
        </div>

        <form method="POST" action="{% url 'submit_idea' challenge.challenge_id %}" enctype="multipart/form-data" id="ideaForm">
            {% csrf_token %}

            <!-- Hidden Fields for form data consolidation -->
            <input type="hidden" name="keywords" id="keywords_hidden" value="">
            <input type="hidden" name="is_confidential" value="off">
            <input type="hidden" name="sharing_scope" value="NONE">
            <input type="hidden" name="problem_statement" id="problem_statement_hidden" value="">
            <input type="hidden" name="proposed_solution" id="proposed_solution_hidden" value="">
            <input type="hidden" name="business_value_non_monetary" value="">
            <input type="hidden" name="risks" id="risks_hidden" value="">
            <input type="hidden" name="innovation_type" value="Challenge Based">

            <!-- Step 1: Your Details -->
            <div class="form-card step-content active step1-card" id="step-1">
                <!-- Section Header -->
                <div class="step1-section-header">
                    <h3 class="step1-section-title">Your Details</h3>
                    <p class="step1-section-description">Auto-populated from your profile</p>
                </div>

                <!-- Employee Information Display -->
                <div class="step1-employee-info-grid">
                    <!-- Row 1: Employee ID & Name -->
                    <div class="step1-employee-row">
                        <!-- Employee ID -->
                        <div class="step1-employee-field">
                            <label class="step1-field-label">Employee ID</label>
                            <div class="step1-field-display">
                                <span class="step1-field-display-span">{{ user.employee_id|default:"N/A" }}</span>
                            </div>
                        </div>

                        <!-- Employee Name -->
                        <div class="step1-employee-field">
                            <label class="step1-field-label">Employee Name</label>
                            <div class="step1-field-display">
                                <span class="step1-field-display-span">{{ user.full_name }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Email & IBU -->
                    <div class="step1-employee-row">
                        <!-- Email ID -->
                        <div class="step1-employee-field">
                            <label class="step1-field-label">Email ID</label>
                            <div class="step1-field-display">
                                <span class="step1-field-display-span step1-field-display-email">{{ user.email }}</span>
                            </div>
                        </div>

                        <!-- IBU -->
                        <div class="step1-employee-field">
                            <label class="step1-field-label">IBU</label>
                            <div class="step1-field-display">
                                <span class="step1-field-display-span">{% if employee_detail and employee_detail.ibu_name %}{{ employee_detail.ibu_name }}{% else %}N/A{% endif %}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Service Line (Full Width) -->
                    <div class="step1-employee-field">
                        <label class="step1-field-label">Service Line</label>
                        <div class="step1-field-display">
                            <span class="step1-field-display-span">{% if employee_detail and employee_detail.service_line %}{{ employee_detail.service_line }}{% else %}N/A{% endif %}</span>
                        </div>
                    </div>
                </div>

                <!-- Info Alert -->
                <div class="step1-info-alert">
                    <div class="step1-info-alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="step1-info-alert-text">
                        These details are automatically populated from your employee profile. If any information is incorrect, please contact BHR to update your records.
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="step1-footer-actions">
                    <button type="button" class="step1-btn-next" onclick="goToStep(2)">Next Step <i class="fa-solid fa-chevron-right ms-2"></i></button>
                </div>
            </div>

            <!-- Step 2: Idea Details -->
            <div class="form-card step-content step2-card" id="step-2">
                <!-- Section Header -->
                <div class="step2-section-header">
                    <div class="step2-section-header-icon"></div>
                    <h3 class="step2-section-title">Idea Details</h3>
                </div>

                <!-- Focus Area Selection Section -->
                <div class="step2-focus-area-section">
                    <div class="step2-focus-area-header">
                        <div class="step2-focus-area-title">
                            Select Your Focus Area
                        </div>
                    </div>

                    <!-- Improvement Categories & Theme Two-Column Layout -->
                    <div class="step2-categories-theme-container">
                        <!-- Left Column: Improvement Categories -->
                        <div class="step2-categories-column">
                            <label class="step2-categories-label">Improvement Categories <span class="required">*</span></label>
                            <div class="step2-categories-list">
                                <div class="step2-category-item active" onclick="selectCategory(this, 'customer_experience')">
                                    <i class="fas fa-check"></i>
                                    <span>Customer Experience</span>
                                </div>
                                <div class="step2-category-item selected" onclick="selectCategory(this, 'time_to_market')">
                                    <span>Time to Market</span>
                                </div>
                                <div class="step2-category-item" onclick="selectCategory(this, 'service_scope')">
                                    <span>Service Scope</span>
                                </div>
                                <div class="step2-category-item" onclick="selectCategory(this, 'cost_optimization')">
                                    <span>Cost Optimization</span>
                                </div>
                                <div class="step2-category-item" onclick="selectCategory(this, 'faster_ttm')">
                                    <span>Faster time to market</span>
                                </div>
                                <div class="step2-category-item" onclick="selectCategory(this, 'product_quality')">
                                    <span>Product Quality</span>
                                </div>
                            </div>
                            <input type="hidden" name="improvement_category" id="improvement_category" value="customer_experience">
                        </div>

                        <!-- Right Column: Improvement Theme -->
                        <div class="step2-theme-column">
                            <label class="step2-theme-label">Improvement Theme <span class="required">*</span></label>
                            <div class="step2-theme-grid">
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_1st_resolution')">
                                    <span>Improving 1st level Resolution</span>
                                </div>
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_kedb')">
                                    <span>Improving KEDB Effectiveness</span>
                                </div>
                                <div class="step2-theme-option active" onclick="selectTheme(this, 'improving_satisfaction')">
                                    <i class="fas fa-check"></i>
                                    <span>Improving Customer Satisfaction</span>
                                </div>
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_security')">
                                    <span>Improving Security Compliance</span>
                                </div>
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_usage')">
                                    <span>Improving Application Usage</span>
                                </div>
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_capacity')">
                                    <span>Improving Application Capacity</span>
                                </div>
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_performance')">
                                    <span>Improving Application Performance</span>
                                </div>
                                <div class="step2-theme-option" onclick="selectTheme(this, 'improving_km')">
                                    <span>Improving KM Effectiveness</span>
                                </div>
                            </div>
                            <input type="hidden" name="improvement_theme" id="improvement_theme" value="improving_satisfaction">
                        </div>
                    </div>
                </div>

                <!-- Idea Name Field (Title) -->
                <div class="step2-form-field">
                    <label class="step2-field-label">Idea Name</label>
                    <input type="text" name="title" class="step2-field-input" placeholder="Enter a descriptive name for your idea" maxlength="200" required>
                    <div class="step2-field-hint">
                        <span>Only Characters, Digits and special characters.;@!?â‚¬*EÃ‡$%'&/#*+4?^~â€¢â€”=]</span>
                        <span class="step2-char-count"><span id="idea-name-count">0</span>/200</span>
                    </div>
                </div>

                <!-- Proposed Idea Field (Description) -->
                <div class="step2-form-field">
                    <label class="step2-field-label">Proposed Idea <span class="required">*</span></label>
                    <textarea name="description" class="step2-field-textarea" placeholder="Briefly describe your idea â€” what you plan to do and the key approach or steps you'll use to make it work" maxlength="1000" required></textarea>
                    <div class="step2-field-hint">
                        <span></span>
                        <span class="step2-char-count"><span id="proposed-idea-count">0</span>/1000</span>
                    </div>
                </div>

                <!-- Keywords Field -->
                <div class="step2-form-field">
                    <label class="step2-field-label">Keywords <span class="required">*</span></label>
                    <div class="step2-tags-container" id="keywords-container" onclick="focusKeywordInput()">


                        <input type="text" class="step2-tag-input" id="keywords-input" placeholder="Add keywords..." onkeydown="handleKeywordInput(event)">
                    </div>
                    <div class="step2-field-hint">Separate with commas</div>
                </div>

                <!-- Tools/Technology Field -->
                <div class="step2-form-field">
                    <label class="step2-field-label">Tools/Technology used <span class="required">*</span></label>
                    <div class="step2-tags-container" id="tools-container" onclick="focusToolInput()">


                        <input type="text" class="step2-tag-input" id="tools-input" placeholder="Add tools..." onkeydown="handleToolInput(event)">
                    </div>
                    <div class="step2-field-hint">What tech/ tools are you using?</div>
                </div>

                <!-- Footer Actions -->
                <div class="step2-footer-actions">
                    <div class="step2-footer-left">
                        <button type="button" class="step2-btn-prev" onclick="goToStep(1)">
                            <i class="fa-solid fa-chevron-left"></i> Prev
                        </button>
                    </div>
                    <div class="step2-footer-right">
                        <button type="button" class="step2-btn-cancel" onclick="cancelForm()">Cancel</button>
                        <button type="button" class="step2-btn-next" onclick="goToStep(3)">
                            Next Step <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Value Proposition -->
            <div class="form-card step-content step3-card" id="step-3">
                <!-- Section Header -->
                <div class="step3-section-header">
                    <div class="step3-section-header-icon"></div>
                    <div class="step3-section-title-container">
                        <h3 class="step3-section-title">Value Proposition</h3>
                        <p class="step3-section-description">Define the expected value and impact</p>
                    </div>
                </div>

                <!-- Business Value Field -->
                <div class="step3-form-field">
                    <label class="step3-field-label">Business Value <span class="required">*</span></label>
                    <textarea name="business_value_monetary" class="step3-field-textarea" placeholder="Describe the business impact of your idea by listing key KPIs, the value to your Service Line, the personas benefitted, how they gain, and what uniquely differentiates your solution" maxlength="1000" required></textarea>
                    <div class="step3-field-hint">
                        <span class="step3-char-count"><span id="business-value-count">0</span>/1000</span>
                    </div>
                </div>

                <!-- Monetary Value Field -->
                <div class="step3-form-field">
                    <label class="step3-field-label">Monetary Value <span class="required">*</span></label>
                    <input type="text" name="monetary_value" class="step3-field-input" placeholder="e.g., $50,000 annual savings" required>
                </div>

                <!-- Additional Info Field (Assumptions) -->
                <div class="step3-form-field">
                    <label class="step3-field-label">Assumptions & Risks</label>
                    <textarea name="assumptions" class="step3-field-textarea" placeholder="Assumptions/ risks/ Additional Commentary" maxlength="1000"></textarea>
                    <div class="step3-field-hint">
                        <span class="step3-char-count"><span id="additional-info-count">0</span>/1000</span>
                    </div>
                </div>

                <!-- Supporting Documents Field -->
                <div class="step3-upload-section">
                    <label class="step3-field-label">Supporting Doc.</label>
                    <div class="step3-upload-container" onclick="document.getElementById('idea_documents').click()">
                        <div class="step3-upload-content">
                            <div class="step3-upload-icon"></div>
                            <span class="step3-upload-text">Upload Supporting Document</span>
                        </div>
                    </div>
                    <input type="file" id="idea_documents" name="idea_documents" class="step3-upload-input" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg">
                </div>

                <!-- Footer Actions -->
                <div class="step3-footer-actions">
                    <div class="step3-footer-left">
                        <button type="button" class="step3-btn-prev" onclick="goToStep(2)">
                            <i class="fa-solid fa-chevron-left"></i> Prev
                        </button>
                    </div>
                    <div class="step3-footer-right">
                        <button type="button" class="step3-btn-cancel" onclick="cancelForm()">Cancel</button>
                        <button type="button" class="step3-btn-next" onclick="goToStep(4)">
                            Next Step <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review & Submit -->
            <div class="form-card step-content step4-card" id="step-4">
                <!-- Section Header -->
                <div class="step4-section-header">
                    <div class="step4-section-header-icon"></div>
                    <div class="step4-section-title-container">
                        <h3 class="step4-section-title">Review & Submit</h3>
                        <p class="step4-section-description">Define the expected value and impact</p>
                    </div>
                </div>

                <!-- Summary Container -->
                <div class="step4-summary-container">
                    <!-- Rewards Box -->
                    <div class="step4-rewards-box">
                        <div class="step4-rewards-icon">
                            <i class="fa-solid fa-award"></i>
                        </div>
                        <p class="step4-rewards-text">
                            Submitting this idea will award you <span class="step4-rewards-highlight">5 IRIS Points</span>!
                        </p>
                    </div>

                    <!-- Your Details Section -->
                    <div class="step4-summary-section">
                        <div class="step4-summary-section-header">
                            <div class="step4-summary-section-icon">
                                <div class="icon-1"></div>
                                <div class="icon-2"></div>
                            </div>
                            <h4 class="step4-summary-section-title">Your Details</h4>
                        </div>
                        <div class="step4-data-grid">
                            <div class="step4-data-row">
                                <div class="step4-data-label">Employee ID</div>
                                <div class="step4-data-value" id="sum-emp-id">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Employee Name</div>
                                <div class="step4-data-value" id="sum-emp-name">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Email ID</div>
                                <div class="step4-data-value" id="sum-email">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">IBU</div>
                                <div class="step4-data-value" id="sum-ibu">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Service Line</div>
                                <div class="step4-data-value" id="sum-service-line">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Idea Details Section -->
                    <div class="step4-summary-section">
                        <div class="step4-summary-section-header">
                            <div></div>
                            <h4 class="step4-summary-section-title" style="margin-left: -22px; margin-top: 5.79px;"><span style="display: inline-block; width: 22px; height: 18.77px; outline: 2px #E31837 solid; outline-offset: -1px; margin-right: 11px; vertical-align: middle;"></span>Idea details</h4>
                        </div>
                        <div class="step4-data-grid">
                            <div class="step4-data-row">
                                <div class="step4-data-label">Improvement Categories</div>
                                <div class="step4-data-value" id="sum-category">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Improvement Theme</div>
                                <div class="step4-data-value" id="sum-theme">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Idea Name</div>
                                <div class="step4-data-value" id="sum-idea-name">-</div>
                            </div>
                            <div class="step4-data-row tall">
                                <div class="step4-data-label">Proposed Idea</div>
                                <div class="step4-data-value tall" id="sum-proposed-idea">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Keywords</div>
                                <div class="step4-tags-container" id="sum-keywords">
                                    <span class="step4-tag"><span class="step4-tag-text">-</span></span>
                                </div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Tools/Technology used</div>
                                <div class="step4-tags-container" id="sum-tools">
                                    <span class="step4-tag"><span class="step4-tag-text">-</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Value Proposition Section -->
                    <div class="step4-summary-section">
                        <div class="step4-summary-section-header">
                            <div></div>
                            <h4 class="step4-summary-section-title" style="margin-left: -22px; margin-top: 5.79px;"><span style="display: inline-block; width: 22px; height: 18.77px; outline: 2px #E31837 solid; outline-offset: -1px; margin-right: 11px; vertical-align: middle;"></span>Value Proposition</h4>
                        </div>
                        <div class="step4-data-grid">
                            <div class="step4-data-row tall">
                                <div class="step4-data-label">Business Value</div>
                                <div class="step4-data-value tall" id="sum-business-value">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Monetary Value</div>
                                <div class="step4-data-value" id="sum-monetary-value">-</div>
                            </div>
                            <div class="step4-data-row tall">
                                <div class="step4-data-label">Additional info</div>
                                <div class="step4-data-value tall" id="sum-additional-info">-</div>
                            </div>
                            <div class="step4-data-row">
                                <div class="step4-data-label">Supporting Document</div>
                                <div class="step4-data-value" id="sum-supporting-docs">
                                    <a href="#" style="color: #E31837; text-decoration: underline;">Preview</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Download Summary Section -->
                    <div class="step4-download-section">
                        <button type="button" class="step4-download-btn" onclick="downloadSummary()">
                            <span>Download Summary</span>
                            <div class="step4-download-icon">
                                <i class="fa-solid fa-download"></i>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="step4-footer-actions">
                    <div class="step4-footer-left">
                        <button type="button" class="step4-btn-prev" onclick="goToStep(3)">
                            <i class="fa-solid fa-chevron-left"></i> Prev
                        </button>
                    </div>
                    <div class="step4-footer-right">
                        <button type="button" class="step4-btn-cancel" onclick="cancelForm()">Cancel</button>
                        <button type="submit" class="step4-btn-submit" id="mainSubmitBtn">Submit Idea</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade success-modal" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="rocket-container">ðŸš€</div>
                <h3 class="fw-bold mb-3">Idea <span class="text-success">submitted</span> successfully!</h3>
                <p class="text-muted mb-4">Good luck with the challenge!</p>
                <div class="mt-4"><a href="{% url 'my_ideas' %}" class="btn btn-success px-4 rounded-pill">View My Ideas</a></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentStep = 1;

    function goToStep(step) {
        if (step > currentStep && !validateStep(currentStep)) return;
        $('.step-content').removeClass('active');
        $(`#step-${step}`).addClass('active');

        $('.wizard-step').each((i, el) => {
            const s = i + 1;
            $(el).removeClass('active completed');
            if (s < step) $(el).addClass('completed');
            else if (s === step) $(el).addClass('active');
        });

        currentStep = step;
        if (step === 4) updateSummary();
        window.scrollTo(0, 0);
    }

    function validateStep(step) {
        let valid = true;
        $(`#step-${step}`).find('[required]').each((i, el) => {
            if (!$(el).val()) { $(el).addClass('is-invalid'); valid = false; }
            else $(el).removeClass('is-invalid');
        });
        return valid;
    }

    function updateSummary() {
        // Step 1: Your Details - Get from display elements
        $('#sum-emp-id').text($('.step1-field-display-span').eq(0).text() || 'N/A');
        $('#sum-emp-name').text($('.step1-field-display-span').eq(1).text() || 'N/A');
        $('#sum-email').text($('.step1-field-display-email').text() || 'N/A');
        $('#sum-ibu').text($('.step1-field-display-span').eq(3).text() || 'N/A');
        $('#sum-service-line').text($('.step1-field-display-span').eq(4).text() || 'N/A');

        // Step 2: Idea Details - Updated field names
        $('#sum-category').text($('#improvement_category').val() || '-');
        $('#sum-theme').text($('#improvement_theme').val() || '-');
        $('#sum-idea-name').text($('[name="title"]').val() || '-');
        $('#sum-proposed-idea').text($('[name="description"]').val() || '-');

        // Step 2: Keywords Tags
        const keywords = document.querySelectorAll('input[name="keywords"]');
        const keywordContainer = document.getElementById('sum-keywords');
        keywordContainer.innerHTML = '';
        if (keywords.length > 0) {
            keywords.forEach(kw => {
                const tag = document.createElement('span');
                tag.className = 'step4-tag';
                tag.innerHTML = `<span class="step4-tag-text">${kw.value}</span>`;
                keywordContainer.appendChild(tag);
            });
        } else {
            keywordContainer.innerHTML = '<span class="step4-tag"><span class="step4-tag-text">-</span></span>';
        }

        // Step 2: Tools/Technology Tags
        const tools = document.querySelectorAll('input[name="tools"]');
        const toolsContainer = document.getElementById('sum-tools');
        toolsContainer.innerHTML = '';
        if (tools.length > 0) {
            tools.forEach(tool => {
                const tag = document.createElement('span');
                tag.className = 'step4-tag';
                tag.innerHTML = `<span class="step4-tag-text">${tool.value}</span>`;
                toolsContainer.appendChild(tag);
            });
        } else {
            toolsContainer.innerHTML = '<span class="step4-tag"><span class="step4-tag-text">-</span></span>';
        }

        // Step 3: Value Proposition - Updated field names
        $('#sum-business-value').text($('[name="business_value_monetary"]').val() || '-');
        $('#sum-monetary-value').text($('[name="monetary_value"]').val() || '-');
        $('#sum-additional-info').text($('[name="assumptions"]').val() || '-');

        // Step 3: Supporting Documents
        const fileInput = document.getElementById('idea_documents');
        const fileCount = fileInput && fileInput.files ? fileInput.files.length : 0;
        if (fileCount > 0) {
            const fileNames = Array.from(fileInput.files).map(f => f.name).join(', ');
            $('#sum-supporting-docs').html(`<a href="#" onclick="return false;" style="color: #E31837; text-decoration: underline;">${fileNames}</a>`);
        } else {
            $('#sum-supporting-docs').html('-');
        }
    }

    // Co-Ideator Logic
    document.addEventListener('DOMContentLoaded', function () {
        const coIdeatorEmail = document.getElementById('coIdeatorEmail');
        const addBtn = document.getElementById('addCoIdeatorBtn');
        const listContainer = document.getElementById('coIdeatorList');

        addBtn.addEventListener('click', function () {
            const email = coIdeatorEmail.value.trim();
            if (email && validateEmail(email)) {
                addCoIdeatorBadge(email);
                coIdeatorEmail.value = '';
            } else {
                alert('Please enter a valid email address.');
            }
        });

        function addCoIdeatorBadge(email) {
            if (document.querySelector(`input[value="${email}"]`)) return;
            const badge = document.createElement('div');
            badge.className = 'badge bg-primary p-2 d-flex align-items-center';
            badge.innerHTML = `<span>${email}</span><input type="hidden" name="co_ideators" value="${email}"><button type="button" class="btn-close btn-close-white ms-2 remove-btn" style="font-size: 0.5rem;"></button>`;
            listContainer.appendChild(badge);
            badge.querySelector('.remove-btn').addEventListener('click', () => badge.remove());
        }

        function validateEmail(email) {
            return String(email).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0:9]{1,3}\.[0:9]{1,3}\.[0:9]{1,3}\.[0:9]{1,3}\])|(([a-zA-Z\-0:9]+\.)+[a-zA-Z]{2,}))$/);
        }

        // Character counter for Title
        const titleInput = document.querySelector('[name="title"]');
        if (titleInput) {
            titleInput.addEventListener('input', function() {
                document.getElementById('idea-name-count').textContent = this.value.length;
            });
        }

        // Character counter for Description
        const descriptionInput = document.querySelector('[name="description"]');
        if (descriptionInput) {
            descriptionInput.addEventListener('input', function() {
                document.getElementById('proposed-idea-count').textContent = this.value.length;
            });
        }

        // Character counter for Business Value
        const businessValueInput = document.querySelector('[name="business_value_monetary"]');
        if (businessValueInput) {
            businessValueInput.addEventListener('input', function() {
                document.getElementById('business-value-count').textContent = this.value.length;
            });
        }

        // Character counter for Assumptions
        const assumptionsInput = document.querySelector('[name="assumptions"]');
        if (assumptionsInput) {
            assumptionsInput.addEventListener('input', function() {
                document.getElementById('additional-info-count').textContent = this.value.length;
            });
        }
    });

    // Category Selection Function
    function selectCategory(element, categoryValue) {
        const allCategories = document.querySelectorAll('.step2-category-item');
        allCategories.forEach(cat => cat.classList.remove('active', 'selected'));
        element.classList.add('active');
        document.getElementById('improvement_category').value = categoryValue;
    }

    // Theme Selection Function
    function selectTheme(element, themeValue) {
        const allThemes = document.querySelectorAll('.step2-theme-option');
        allThemes.forEach(theme => theme.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('improvement_theme').value = themeValue;
    }

    // Keywords Tag Functions
    function focusKeywordInput() {
        document.getElementById('keywords-input').focus();
    }

    function handleKeywordInput(event) {
        if (event.key === 'Enter' || event.key === ',') {
            event.preventDefault();
            const input = event.target;
            const keyword = input.value.trim().replace(/,/g, '');
            if (keyword) {
                addKeywordTag(keyword);
                input.value = '';
            }
        }
    }

    function addKeywordTag(keyword) {
        const container = document.getElementById('keywords-container');
        const tag = document.createElement('div');
        tag.className = 'step2-tag';
        tag.innerHTML = `
            <div class="step2-tag-icon">+</div>
            <span>${keyword}</span>
            <button type="button" class="step2-tag-remove-btn" onclick="removeTag(event)">Ã—</button>
            <input type="hidden" name="keywords" value="${keyword}">
        `;
        container.insertBefore(tag, document.getElementById('keywords-input'));
    }

    // Tools Tag Functions
    function focusToolInput() {
        document.getElementById('tools-input').focus();
    }

    function handleToolInput(event) {
        if (event.key === 'Enter' || event.key === ',') {
            event.preventDefault();
            const input = event.target;
            const tool = input.value.trim().replace(/,/g, '');
            if (tool) {
                addToolTag(tool);
                input.value = '';
            }
        }
    }

    function addToolTag(tool) {
        const container = document.getElementById('tools-container');
        const tag = document.createElement('div');
        tag.className = 'step2-tag';
        tag.innerHTML = `
            <div class="step2-tag-icon">+</div>
            <span>${tool}</span>
            <button type="button" class="step2-tag-remove-btn" onclick="removeTag(event)">Ã—</button>
            <input type="hidden" name="tools" value="${tool}">
        `;
        container.insertBefore(tag, document.getElementById('tools-input'));
    }

    // Remove Tag Function
    function removeTag(event) {
        event.preventDefault();
        event.target.closest('.step2-tag').remove();
    }

    // Cancel Form Function
    function cancelForm() {
        if (confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
            window.location.href = '{% url "my_ideas" %}';
        }
    }

    // Form Submit Handler - Consolidate data before submission
    document.getElementById('ideaForm').addEventListener('submit', function(e) {
        // Consolidate keywords from tags
        const keywords = document.querySelectorAll('input[name="keywords"]');
        const keywordsList = Array.from(keywords).map(kw => kw.value).join(', ');
        document.getElementById('keywords_hidden').value = keywordsList;

        // Copy description to problem_statement and proposed_solution for compatibility
        const description = document.querySelector('[name="description"]').value;
        document.getElementById('problem_statement_hidden').value = description;
        document.getElementById('proposed_solution_hidden').value = description;

        // Copy assumptions to risks for compatibility
        const assumptions = document.querySelector('[name="assumptions"]').value;
        document.getElementById('risks_hidden').value = assumptions;
        
        // Form will now submit with all required fields
    });
</script>
{% endblock %}